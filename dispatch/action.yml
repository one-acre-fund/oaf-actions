name: Dispatch Deployment Event
description: Trigger a deployment event for a specific workflow run.
inputs:
  TOKEN:
    description: The GitHub token to use for the dispatch.
    required: true
  RUN_ID:
    description: The run id of the workflow to dispatch.
    required: true
  REF:
    description: The name of the branch to deploy.
    required: true
  REF_NAME:
    description: The name of the branch to deploy.
    required: true
  SHA:
    description: The commit sha to deploy.
    required: true
  OWNER:
    description: The owner of the repository to dispatch the workflow to.
    required: true
  CI_REPOSITORY:
    description: The name of the repository to dispatch the workflow from.
    required: true
  CD_REPOSITORY:
    description: The name of the repository to dispatch the workflow to.
    required: true
  API_VERSION:
    description: The GitHub API version to use.
    default: 2022-11-28
    required: false

runs:
  using: composite
  steps:
    - name: Dispatch deployment event
      if: (inputs.REF == 'refs/heads/main' || inputs.REF == 'refs/heads/develop' || contains(inputs.REF, 'refs/heads/release'))
      run: |
        # Get workflow using run id
        echo "Getting the workflow using the run id..."
        WORKFLOW=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ inputs.TOKEN }}" "https://api.github.com/repos/${{ inputs.OWNER }}/${{ inputs.CI_REPOSITORY }}/actions/runs/${{ inputs.RUN_ID }}")

        echo $WORKFLOW | jq .

        # Check if the workflow run exists
        if [ "$(echo $WORKFLOW | jq -r '.workflow_run.id')" == "null" ]; then
          echo "The workflow run does not exist. Exiting..."
          exit 0
        fi

        if [ "$(echo $WORKFLOW | jq -r '.workflow_run.event') != 'push'" ]; then
          echo "The event was not triggered by a push event. Exiting..."
          exit 0
        fi

        if [ "$(echo $WORKFLOW | jq -r '.workflow_run.head_branch')" != "${{ inputs.REF_NAME }}" ]; then
          echo "The branch name provided does not match the workflow run branch name. Exiting..."
          exit 0
        fi

        # Displaying the starting message
        echo "Starting to trigger GitHub Actions workflow..."

        # Define the URL and payload
        URL="https://api.github.com/repos/${{ inputs.OWNER }}/${{ inputs.CD_REPOSITORY }}/actions/workflows/deploy.yml/dispatches"
        PAYLOAD=$(cat <<EOF
        {
          "ref": "main",
          "inputs": {
            "run_id": "${{ inputs.RUN_ID }}",
            "ref": "${{ inputs.REF }}",
            "ref_name": "${{ inputs.REF_NAME }}",
            "sha": "${{ inputs.SHA }}",
            "repository": "${{ inputs.CI_REPOSITORY }}"
          }
        }
        EOF
        )

        # Displaying the URL and Payload
        echo "GitHub API URL: $URL"
        echo "Payload: $PAYLOAD"

        # Triggering the GitHub Actions workflow
        HTTP_CODE=$(curl -L -s -o /dev/null -w "%{http_code}" \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ inputs.TOKEN }}" \
          -H "X-GitHub-Api-Version: ${{ inputs.API_VERSION }}" \
          "$URL" \
          -d "$PAYLOAD")

        # Checking the response code
        echo "HTTP response code: $HTTP_CODE"

        if [ "$HTTP_CODE" -eq 204 ]; then
          echo "Successfully triggered the GitHub Actions workflow."
        else
          echo "Failed to trigger the GitHub Actions workflow. HTTP code: $HTTP_CODE"
          exit 1
        fi
      shell: bash
